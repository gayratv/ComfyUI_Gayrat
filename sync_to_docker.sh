#!/bin/bash

set -e
#set -x

# ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ====
SRC_DIR="/mnt/f/_prg/python/ComfyUI_Gayrat"
CONTAINER_NAME="comfyui-union2"
DEST_PATH="/workspace/ComfyUI/custom_nodes/ComfyUI_Gayrat"

# ==== –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—É—Ç–∏ ====
TMP_DIR="/mnt/d/_tmp/ComfyUI_Gayrat_sync"

# ==== –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏ ====
EXCLUDE_OPTS=(
  --exclude='.git'
  --exclude='.github'
  --exclude='.idea'
  --exclude='.venv'
)

# ==== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ====
#if [ -d "$TMP_DIR" ]; then
#  rm -rf "$TMP_DIR"
#fi

rm -rf "$TMP_DIR"
mkdir -p "$TMP_DIR"
ls "$TMP_DIR"

# ==== –ö–æ–ø–∏—Ä—É–µ–º —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ ====
echo "üîç –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª—å–Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏..."
#rsync -av "${EXCLUDE_OPTS[@]}" "$SRC_DIR/" "$TMP_DIR/"
#rsync -rv "${EXCLUDE_OPTS[@]}" "$SRC_DIR/" "$TMP_DIR/"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –æ—à–∏–±–∫—É getcwd()
(cd "$SRC_DIR" && rsync -rv "${EXCLUDE_OPTS[@]}" ./ "$TMP_DIR/")

# ==== –ö–æ–ø–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ====
echo "üêã –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_NAME..."
docker exec comfyui-union2 rm -rf /workspace/ComfyUI/custom_nodes/ComfyUI_Gayrat/
docker exec -it "$CONTAINER_NAME" mkdir -p "$DEST_PATH"
docker cp "$TMP_DIR/." "$CONTAINER_NAME:$DEST_PATH"

# ==== –û—á–∏—Å—Ç–∫–∞ ====
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -rf "$TMP_DIR"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:"
echo "   $CONTAINER_NAME:$DEST_PATH"